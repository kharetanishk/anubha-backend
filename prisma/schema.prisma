generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                    String           @id @default(uuid())
  name                  String
  role                  Role             @default(USER)
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt
  email                 String?          @unique
  phone                 String?          @unique
  password              String?        
  resetPasswordToken    String?
  resetPasswordExpiry   DateTime?
  archivedAt            DateTime?
  isArchived            Boolean          @default(false)
  appointments          Appointment[]
  patients              PatientDetials[]

  @@index([phone])
  @@index([email])
  @@index([isArchived])
  @@index([resetPasswordToken])
  // Composite index for admin users list query (isArchived filter + createdAt ordering)
  @@index([isArchived, createdAt])
}

model OTP {
  id        String   @id @default(uuid())
  code      String
  expiresAt DateTime
  createdAt DateTime @default(now())
  phone     String?
  email     String?

  @@index([phone])
  @@index([email])
  @@index([expiresAt])
  @@index([phone, expiresAt])
  @@index([email, expiresAt])
}

model Testimonial {
  id        String   @id @default(uuid())
  name      String
  text      String
  imageUrl  String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isActive])
  // Composite index for admin testimonials list query (isActive filter + createdAt ordering)
  @@index([isActive, createdAt])
}


model Admin {
  id                String              @id @default(uuid())
  name              String
  phone             String?              @unique
  createdAt         DateTime            @default(now())
  updatedAt         DateTime          @updatedAt
  email             String?              @unique
  password          String             
  profilePictureUrl String?
  archivedAt        DateTime?
  isArchived        Boolean             @default(false)
  appointments      Appointment[]       @relation("DoctorAppointments")
  doctorDaysOff     DoctorDayOff[]
  DoctorFormSession DoctorFormSession[]
  slots             Slot[]

  @@index([email])
  @@index([phone])
  @@index([isArchived])
}

model PatientDetials {
  id                  String              @id @default(uuid())
  userId              String
  name                String
  age                 Int
  gender              Gender
  weight              Float
  height              Float
  neck                Float?
  waist               Float?
  hip                 Float?
  wakeUpTime          String
  sleepTime           String
  sleepQuality        SleepQuality
  dailyWaterIntake    Int
  medicalHistory      String?
  bowelMovement       BowelMovement
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
  address             String
  appointmentConcerns String?
  dailyFoodIntake     String?
  dateOfBirth         DateTime
  email               String
  phone               String
  allergic            String?
  archivedAt          DateTime?
  foodPreference      FoodPreference
  isArchived          Boolean             @default(false)
  abdomenLower        Float?
  abdomenUpper        Float?
  ankle               Float?
  arms                Float?
  calf                Float?
  chest               Float?
  chestFemale         Float?
  expandedChestLungs  Float?
  forearms            Float?
  normalChestLung     Float?
  thighLower          Float?
  thighUpper          Float?
  wrist               Float?
  appointments        Appointment[]
  DoctorFormSession   DoctorFormSession[]
  files               File[]
  user                User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  recalls             Recall[]            @relation("PatientRecalls")

  @@unique([userId, name])
  @@index([userId])
  @@index([phone])
  @@index([email])
  @@index([isArchived])
  // Composite index for admin all patients list query (isArchived filter + createdAt ordering)
  @@index([isArchived, createdAt])
  // Composite index for user patients list query (userId + isArchived filter + createdAt ordering)
  @@index([userId, isArchived, createdAt])
}

model Recall {
  id            String         @id @default(uuid())
  patientId     String
  appointmentId String?        @unique
  notes         String?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  archivedAt    DateTime?
  isArchived    Boolean        @default(false)
  appointment   Appointment?   @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  patient       PatientDetials @relation("PatientRecalls", fields: [patientId], references: [id], onDelete: Cascade)
  entries       RecallEntry[]

  @@index([patientId])
  @@index([appointmentId])
  @@index([isArchived])
}

model RecallEntry {
  id        String   @id @default(uuid())
  recallId  String
  mealType  MealType
  time      String
  foodItem  String
  quantity  String
  notes     String?
  createdAt DateTime @default(now())
  recall    Recall   @relation(fields: [recallId], references: [id], onDelete: Cascade)

  @@index([recallId, mealType])
  @@index([mealType])
}

model File {
  id            String          @id @default(uuid())
  url           String
  fileName      String
  mimeType      String
  createdAt     DateTime        @default(now())
  provider      StorageProvider @default(CLOUDINARY)
  sizeInBytes   Int
  updatedAt     DateTime        @updatedAt
  patientId     String?
  appointmentId String?
  publicId      String
  archivedAt    DateTime?
  isArchived    Boolean         @default(false)
  patient       PatientDetials? @relation(fields: [patientId], references: [id], onDelete: Cascade)
  appointment   Appointment?     @relation(fields: [appointmentId], references: [id], onDelete: Cascade)

  @@index([patientId])
  @@index([appointmentId])
  @@index([isArchived])
}

model Slot {
  id           String          @id @default(uuid())
  isBooked     Boolean         @default(false)
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
  endAt        DateTime
  startAt      DateTime
  mode         AppointmentMode
  adminId      String
  archivedAt   DateTime?
  isArchived   Boolean         @default(false)
  appointments Appointment[]
  admin        Admin           @relation(fields: [adminId], references: [id], onDelete: Cascade)

  @@unique([adminId, startAt])
  @@index([adminId, startAt, isBooked])
  @@index([startAt, isBooked])
  @@index([isArchived])
}

model Appointment {
  id                      String              @id @default(uuid())
  status                  AppointmentStatus   @default(PENDING)
  userId                  String
  doctorId                String
  paymentId               String?
  amount                  Int?
  createdAt               DateTime            @default(now())
  updatedAt               DateTime            @updatedAt
  endAt                   DateTime
  reminderSent            Boolean             @default(false)
  slotId                  String?
  startAt                 DateTime
  notes                   String?
  patientId               String
  planDuration            String
  planName                String
  planPackageName         String?
  planPrice               Int
  planSlug                String
  mode                    AppointmentMode
  shortNoticeReminderSent Boolean             @default(false)
  paymentStatus           String              @default("PENDING")
  archivedAt              DateTime?
  isArchived              Boolean             @default(false)
  bookingProgress         BookingProgress?
  reminderTime            DateTime?
  deletedByAdminAt        DateTime?
  deletedByAdminReason    String?
  isDeletedByAdmin        Boolean             @default(false)
  doctor                  Admin               @relation("DoctorAppointments", fields: [doctorId], references: [id])
  patient                 PatientDetials      @relation(fields: [patientId], references: [id], onDelete: Cascade)
  slot                    Slot?               @relation(fields: [slotId], references: [id])
  user                    User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  DoctorFormSession       DoctorFormSession[]
  invoice                 Invoice?
  MessageLog              MessageLog[]
  recall                  Recall?
  Reminder                Reminder[]
  doctorNotes             DoctorNotes?
  files                   File[]

  @@index([startAt])
  @@index([doctorId, startAt])
  @@index([patientId, startAt])
  @@index([status, startAt])
  @@index([bookingProgress])
  @@index([status, bookingProgress])
  @@index([slotId, status])
  @@index([reminderTime, reminderSent])
  @@index([isArchived])
  @@index([paymentId]) // CRITICAL: Index for payment verification queries
  @@index([userId, paymentId, isArchived]) // Composite index for common payment lookup pattern
  @@index([isDeletedByAdmin])
  // Composite index optimized for adminGetAppointments query pattern:
  // WHERE isArchived = false AND isDeletedByAdmin = false
  //   AND optional status/mode filters
  //   AND optional startAt date range
  @@index([isArchived, isDeletedByAdmin, status, mode, startAt])
  // Composite index for user appointments list query (userId + status filter + startAt ordering)
  @@index([userId, status, startAt])
}

model DoctorDayOff {
  id         String    @id @default(uuid())
  date       DateTime
  reason     String?
  createdAt  DateTime  @default(now())
  adminId    String
  archivedAt DateTime?
  isArchived Boolean   @default(false)
  admin      Admin     @relation(fields: [adminId], references: [id], onDelete: Cascade)

  @@unique([adminId, date])
  @@index([date])
  @@index([adminId, date])
  @@index([isArchived])
}

model WebhookEvent {
  id        String   @id @default(uuid())
  eventId   String   @unique
  createdAt DateTime @default(now())

  @@index([createdAt])
}

model DoctorNotes {
  id                      String                 @id @default(cuid())
  appointmentId           String                 @unique
  formVersion             String                 @default("1.0.0")
  isDraft                 Boolean                @default(true)
  isCompleted             Boolean                @default(false)
  completedAt             DateTime?
  submittedAt             DateTime?
  notes                   String?
  createdAt               DateTime               @default(now())
  updatedAt               DateTime               @updatedAt
  createdBy               String?
  updatedBy               String?
  isArchived              Boolean                @default(false)
  archivedAt              DateTime?
  personalHistory         String?
  reasonForJoiningProgram String?
  ethnicity               String?
  joiningDate             DateTime?
  expiryDate              DateTime?
  dietPrescriptionDate    DateTime?
  durationOfDiet          String?
  maritalStatus           String?
  numberOfChildren        Int?
  dietPreference          String?
  wakeupTime              String?
  bedTime                 String?
  dayNap                  String?
  workoutTiming           String?
  workoutType             String?
  formData                Json?
  /// Section 8 (Body Measurements) extracted for queryability and forward-compatible structure.
  /// This mirrors `formData.bodyMeasurements` and is kept in sync by the backend.
  bodyMeasurements        Json?                  @map("body_measurements")
  analyticsData           Json?
  attachments             DoctorNoteAttachment[]
  foodFrequencyItems      FoodFrequencyItem[]
  healthConditions        HealthCondition[]
  mealEntries             MealEntry[]
  questionnaireAnswers    QuestionnaireAnswer[]
  appointment             Appointment            @relation(fields: [appointmentId], references: [id], onDelete: Cascade)

  @@index([appointmentId])
  @@index([createdAt])
  @@index([formVersion])
  @@index([isCompleted, submittedAt])
  @@index([isDraft])
  @@index([isArchived, archivedAt])
  @@index([createdBy])
  @@index([submittedAt])
  @@map("doctor_notes")
}

model MealEntry {
  id            String      @id @default(cuid())
  doctorNotesId String
  mealPeriod    MealPeriod
  time          String?
  foodItems     Json
  waterIntake   Int?
  medicines     String?
  notes         String?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  isArchived    Boolean     @default(false)
  archivedAt    DateTime?
  doctorNotes   DoctorNotes @relation(fields: [doctorNotesId], references: [id], onDelete: Cascade)

  @@unique([doctorNotesId, mealPeriod])
  @@index([doctorNotesId, mealPeriod])
  @@index([mealPeriod])
  @@index([doctorNotesId])
  @@index([isArchived])
}

model FoodFrequencyItem {
  id            String      @id @default(cuid())
  doctorNotesId String
  category      String
  itemName      String
  checked       Boolean     @default(false)
  quantity      String?
  frequency     String?
  metadata      Json?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  isArchived    Boolean     @default(false)
  archivedAt    DateTime?
  doctorNotes   DoctorNotes @relation(fields: [doctorNotesId], references: [id], onDelete: Cascade)

  @@unique([doctorNotesId, category, itemName])
  @@index([doctorNotesId, category])
  @@index([category, itemName])
  @@index([doctorNotesId])
  @@index([checked, category])
  @@index([isArchived])
}

model HealthCondition {
  id            String      @id @default(cuid())
  doctorNotesId String
  conditionName String
  hasCondition  String
  notes         String?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  isArchived    Boolean     @default(false)
  archivedAt    DateTime?
  doctorNotes   DoctorNotes @relation(fields: [doctorNotesId], references: [id], onDelete: Cascade)

  @@unique([doctorNotesId, conditionName])
  @@index([doctorNotesId])
  @@index([conditionName, hasCondition])
  @@index([hasCondition])
  @@index([isArchived])
}

model QuestionnaireAnswer {
  id            String      @id @default(cuid())
  doctorNotesId String
  questionKey   String
  answer        String?
  answerType    String?
  otherValue    String?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  isArchived    Boolean     @default(false)
  archivedAt    DateTime?
  doctorNotes   DoctorNotes @relation(fields: [doctorNotesId], references: [id], onDelete: Cascade)

  @@unique([doctorNotesId, questionKey])
  @@index([doctorNotesId, questionKey])
  @@index([questionKey])
  @@index([doctorNotesId])
  @@index([isArchived])
}

model DoctorNoteAttachment {
  id            String             @id @default(uuid())
  doctorNotesId String
  fileName      String
  filePath      String
  fileUrl       String?
  mimeType      String
  sizeInBytes   Int
  provider      StorageProvider    @default(CLOUDINARY)
  fileCategory  AttachmentCategory @default(OTHER)
  section       String?
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  isArchived    Boolean            @default(false)
  archivedAt    DateTime?
  doctorNotes   DoctorNotes        @relation(fields: [doctorNotesId], references: [id], onDelete: Cascade)

  @@index([doctorNotesId])
  @@index([doctorNotesId, fileCategory])
  @@index([fileCategory])
  @@index([section])
  @@index([isArchived])
}

model FormSchema {
  id          String    @id @default(uuid())
  version     String    @unique
  schema      Json
  description String?
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  isArchived  Boolean   @default(false)
  archivedAt  DateTime?

  @@index([version, isActive])
  @@index([isActive])
  @@index([isArchived])
}

model DoctorFormSession {
  id            String          @id @default(uuid())
  appointmentId String?
  patientId     String?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  adminId       String?
  archivedAt    DateTime?
  isArchived    Boolean         @default(false)
  admin         Admin?          @relation(fields: [adminId], references: [id], onDelete: Cascade)
  appointment   Appointment?    @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  patient       PatientDetials? @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([patientId])
  @@index([adminId])
  @@index([appointmentId])
  @@index([isArchived])
}

model Reminder {
  id            String      @id @default(uuid())
  appointmentId String
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  archivedAt    DateTime?
  isArchived    Boolean     @default(false)
  appointment   Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)

  @@index([appointmentId])
  @@index([isArchived])
}

model MessageLog {
  id            String      @id @default(uuid())
  appointmentId String
  archivedAt    DateTime?
  createdAt     DateTime    @default(now())
  isArchived    Boolean     @default(false)
  updatedAt     DateTime    @updatedAt
  appointment   Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)

  @@index([appointmentId])
  @@index([isArchived])
}

model Invoice {
  id            String      @id @default(uuid())
  invoiceNumber String      @unique // Sequential invoice number (e.g., INV-0001)
  invoiceDate   DateTime    @default(now())
  appointmentId String      @unique // One invoice per appointment
  pdfPath       String?     // Local file path to PDF
  pdfUrl        String?     // Public URL if stored in cloud
  paymentId     String?     // Razorpay Payment ID
  orderId       String?     // Razorpay Order ID
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  isArchived    Boolean     @default(false)
  archivedAt    DateTime?
  appointment   Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)

  @@index([appointmentId])
  @@index([invoiceNumber])
  @@index([invoiceDate])
  @@index([isArchived])
}

enum Role {
  USER
  ADMIN
}

enum AppointmentStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
}

enum BookingProgress {
  USER_DETAILS
  RECALL
  SLOT
  PAYMENT
}

enum AppointmentMode {
  IN_PERSON
  ONLINE
}

enum StorageProvider {
  CLOUDINARY
  S3
  LOCAL
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum SleepQuality {
  NORMAL
  IRREGULAR
  DISTURBED
  INSOMNIA
}

enum FoodPreference {
  VEG
  NON_VEG
  EGG_VEG
}

enum BowelMovement {
  NORMAL
  CONSTIPATION
  DIARRHEA
  IRREGULAR
}

enum MealType {
  PRE_WAKEUP
  BREAKFAST
  MID_MEAL
  LUNCH
  MID_EVENING
  DINNER
  OTHER
}

enum DoctorFieldType {
  TEXT
  NUMBER
  SELECT
  MULTISELECT
  RADIO
  BOOLEAN
  DATE
  TIME
  TEXTAREA
}

enum FormSectionType {
  PERSONAL_INFO
  FOOD_RECALL_24H
  WEEKEND_DIET
  QUESTIONNAIRE
  FOOD_FREQUENCY
  HEALTH_PROFILE
  DIET_PRESCRIBED
}

enum MealPeriod {
  MORNING_INTAKE
  BREAKFAST
  MID_MORNING
  LUNCH
  MID_DAY
  EVENING_SNACK
  DINNER
}

enum AttachmentCategory {
  DIET_CHART
  LAB_REPORT
  PRESCRIPTION
  IMAGE
  DOCUMENT
  OTHER
}
