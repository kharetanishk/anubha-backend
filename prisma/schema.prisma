generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/**
 * ---------------------------
 * ENUMS
 * ----------------------------
 */
enum Role {
  USER
  ADMIN
}

enum AppointmentStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
}

enum AppointmentMode {
  IN_PERSON
  ONLINE
}

enum StorageProvider {
  CLOUDINARY
  S3
  LOCAL
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum SleepQuality {
  NORMAL
  IRREGULAR
  DISTURBED
  INSOMNIA
}

enum FoodPreference {
  VEG
  NON_VEG
  EGG_VEG
}

enum BowelMovement {
  NORMAL
  CONSTIPATION
  DIARRHEA
  IRREGULAR
}

enum MealType {
  PRE_WAKEUP
  BREAKFAST
  MID_MEAL
  LUNCH
  MID_EVENING
  DINNER
  OTHER
}

enum DoctorFieldType {
  TEXT
  NUMBER
  SELECT
  MULTISELECT
  RADIO
  BOOLEAN
  DATE
  TIME
  TEXTAREA
}

/**
 * ---------------------------
 * AUTH / CORE MODELS
 * ----------------------------
 */
model User {
  id            String           @id @default(uuid())
  name          String
  email         String           @unique
  // phone      String           @unique
  role          Role             @default(USER)
  patients      PatientDetials[]
  appointments  Appointment[]
  refreshTokens RefreshToken[]
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
}

model OTP {
  id        String   @id @default(uuid())
  email     String
  code      String
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([email])
}

model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  userId  String?
  adminId String?

  user  User?  @relation(fields: [userId], references: [id])
  admin Admin? @relation(fields: [adminId], references: [id])
}

model Admin {
  id    String @id @default(uuid())
  name  String
  email String @unique
  phone String @unique

  slots         Slot[]
  doctorDaysOff DoctorDayOff[]
  appointments  Appointment[]  @relation("DoctorAppointments")
  refreshTokens RefreshToken[]

  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  DoctorFormSession DoctorFormSession[]
}

/**
 * ---------------------------
 * PATIENT / RECALL / FILES
 * ----------------------------
 */
model PatientDetials {
  id          String   @id @default(uuid())
  user        User     @relation(fields: [userId], references: [id])
  userId      String
  name        String
  phone       String
  gender      Gender
  email       String
  dateOfBirth DateTime
  age         Int
  address     String

  // Step 2 â€” Body Measurements
  weight Float
  height Float
  neck   Float
  waist  Float
  hip    Float

  medicalHistory      String?
  appointmentConcerns String?
  files               File[]

  bowelMovement    BowelMovement
  dailyFoodIntake  String?
  dailyWaterIntake Int
  wakeUpTime       String
  sleepTime        String
  sleepQuality     SleepQuality

  recalls           Recall[]            @relation("PatientRecalls")
  appointments      Appointment[]
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  DoctorFormSession DoctorFormSession[]

  @@unique([userId, name])

}

model Recall {
  id        String         @id @default(uuid())
  patient   PatientDetials @relation("PatientRecalls", fields: [patientId], references: [id])
  patientId String

  appointment   Appointment? @relation(fields: [appointmentId], references: [id])
  appointmentId String?      @unique

  notes   String? // universal notes
  entries RecallEntry[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model RecallEntry {
  id       String @id @default(uuid())
  recall   Recall @relation(fields: [recallId], references: [id])
  recallId String

  mealType MealType
  time     String
  foodItem String
  quantity String
  notes    String?

  createdAt DateTime @default(now())
}

model File {
  id          String          @id @default(uuid())
  url         String
  publicId    String
  fileName    String
  mimeType    String
  sizeInBytes Int
  provider    StorageProvider @default(CLOUDINARY)

  patient   PatientDetials? @relation(fields: [patientId], references: [id])
  patientId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

/**
 * ---------------------------
 * SLOTS / APPOINTMENTS / DAYS OFF
 * ----------------------------
 */
model Slot {
  id      String @id @default(uuid())
  admin   Admin  @relation(fields: [adminId], references: [id])
  adminId String

  startAt  DateTime
  endAt    DateTime
  mode     AppointmentMode
  isBooked Boolean         @default(false)

  appointment Appointment?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Prevent duplicate slots for same admin + start time
  @@unique([adminId, startAt])
  @@index([adminId, startAt, isBooked])
}

model Appointment {
  id      String            @id @default(uuid())
  startAt DateTime
  endAt   DateTime
  status  AppointmentStatus @default(PENDING)

  user   User   @relation(fields: [userId], references: [id])
  userId String

  // Doctor is the Admin (single-doctor app, but scalable)
  doctor   Admin  @relation("DoctorAppointments", fields: [doctorId], references: [id])
  doctorId String

  patient   PatientDetials @relation(fields: [patientId], references: [id])
  patientId String

  slot   Slot?   @relation(fields: [slotId], references: [id])
  slotId String? @unique

  paymentId    String?
  amount       Int?
  notes        String?
  reminderSent Boolean @default(false)
  shortNoticeReminderSent Boolean @default(false)

  // PLAN DETAILS
  planSlug        String
  planName        String
  planPrice       Int
  planDuration    String
  planPackageName String?
  mode            AppointmentMode

  recall            Recall?
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  DoctorFormSession DoctorFormSession[]

  @@index([startAt])
  @@index([doctorId, startAt])
}

model DoctorDayOff {
  id      String @id @default(uuid())
  admin   Admin  @relation(fields: [adminId], references: [id])
  adminId String

  // store as date with 00:00 time
  date      DateTime
  reason    String?
  createdAt DateTime @default(now())

  @@unique([adminId, date])
  @@index([date])
}

model WebhookEvent {
  id        String   @id @default(uuid())
  eventId   String   @unique
  createdAt DateTime @default(now())
}

model DoctorFieldGroup {
  id        String              @id @default(uuid())
  key       String              @unique // eg "personal", "sleep", "meals", "medical"
  title     String
  order     Int                 @default(0)
  fields    DoctorFieldMaster[]
  createdAt DateTime            @default(now())
  updatedAt DateTime            @updatedAt
}

model DoctorFieldMaster {
  id          String            @id @default(uuid())
  key         String            @unique // machine key e.g., "alcohol_consumption"
  label       String // UI label
  description String?
  type        DoctorFieldType
  placeholder String?
  required    Boolean           @default(false)
  group       DoctorFieldGroup? @relation(fields: [groupId], references: [id], onDelete: SetNull)
  groupId     String?
  order       Int               @default(0)

  // SELECT / MULTISELECT / RADIO -> options here
  options DoctorFieldOption[]

  active Boolean @default(true)

  createdAt            DateTime               @default(now())
  updatedAt            DateTime               @updatedAt
  DoctorFormFieldValue DoctorFormFieldValue[]

  @@index([key])
  @@index([groupId, order])
}

model DoctorFieldOption {
  id        String            @id @default(uuid())
  field     DoctorFieldMaster @relation(fields: [fieldId], references: [id], onDelete: Cascade)
  fieldId   String
  value     String // stored value
  label     String // display label
  order     Int               @default(0)
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt

  @@unique([fieldId, value])
  @@index([fieldId])
}

/**
 * One doctor form session (created when admin clicks + for a patient/appointment)
 */
model DoctorFormSession {
  id String @id @default(uuid())

  appointment   Appointment? @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  appointmentId String?

  patient   PatientDetials @relation(fields: [patientId], references: [id], onDelete: Cascade)
  patientId String

  doctor   Admin  @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  doctorId String

  title     String? // e.g., "Initial assessment"
  notes     String? // free text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  values DoctorFormFieldValue[]

  @@index([patientId])
  @@index([doctorId])
}

model DoctorFormFieldValue {
  id        String            @id @default(uuid())
  session   DoctorFormSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  sessionId String

  field   DoctorFieldMaster @relation(fields: [fieldId], references: [id], onDelete: Cascade)
  fieldId String

  // typed values
  stringValue  String?
  numberValue  Float?
  booleanValue Boolean?
  dateValue    DateTime?
  timeValue    String?
  jsonValue    Json? // for multi-select or structured data

  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([sessionId])
  @@index([fieldId])
}


model Reminder {
  id            String    @id @default(uuid())
  appointment   Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  appointmentId String
  toUser        Boolean   @default(true)        // true => user, false => doctor (we create two reminders per appointment)
  scheduledAt   DateTime
  sentAt        DateTime? 
  status        String    @default("PENDING")  // PENDING | SENT | FAILED
  attempts      Int       @default(0)
  lastError     String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([scheduledAt])
  @@index([appointmentId])
}

model MessageLog {
  id          String   @id @default(uuid())
  appointment Appointment? @relation(fields: [appointmentId], references: [id])
  appointmentId String?
  toNumber    String
  channel     String   // "WHATSAPP"
  template    String?
  payload     Json?
  sentAt      DateTime @default(now())
  status      String   // "SENT" | "FAILED"
  error       String?
}
