generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url = env("DATABASE_URL")
}

enum Role {
  USER
  ADMIN
}

enum AppointmentStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
}

enum ServiceType {
  NUTRITION
  FITNESS
  DIET_PLAN
}

enum StorageProvider {
  CLOUDINARY
  S3
  LOCAL
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum SleepQuality {
  NORMAL
  IRREGULAR
  DISTURBED
  INSOMNIA
}

enum FoodPreference {
  VEG
  NON_VEG
  EGG_VEG
}

enum BowelMovement {
  NORMAL
  CONSTIPATION
  DIARRHEA
  IRREGULAR
}

enum MealType {
  PRE_WAKEUP
  BREAKFAST
  MID_MEAL
  LUNCH
  MID_EVENING
  DINNER
  OTHER
}

model User {
  id            String           @id @default(uuid())
  name          String
  email         String           @unique
  // phone        String        @unique
  role          Role             @default(USER)
  patients      PatientDetials[]
  appointments  Appointment[]
  refreshTokens RefreshToken[]
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
}

model OTP {
  id        String   @id @default(uuid())
  email     String
  code      String
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([email])
}

model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  userId  String?
  adminId String?

  user  User?  @relation(fields: [userId], references: [id])
  admin Admin? @relation(fields: [adminId], references: [id])
}

model Admin {
  id            String         @id @default(uuid())
  name          String
  email         String         @unique
  phone         String         @unique
  refreshTokens RefreshToken[]
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
}

model PatientDetials {
  id          String   @id @default(uuid())
  user        User     @relation(fields: [userId], references: [id])
  userId      String
  name        String
  phone       String
  gender      Gender
  email       String
  dateOfBirth DateTime
  age         Int
  address     String

  /**
   * * Step 2 â€” Body Measurements **
   */
  weight Float
  height Float
  neck   Float
  waist  Float
  hip    Float

  medicalHistory      String?
  appointmentConcerns String?
  files               File[]

  bowelMovement    BowelMovement
  dailyFoodIntake  String?
  dailyWaterIntake Int
  wakeUpTime       String
  sleepTime        String
  sleepQuality     SleepQuality

  recalls      Recall[]      @relation("PatientRecalls")
  appointments Appointment[]
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
}

model Recall {
  id        String         @id @default(uuid())
  patient   PatientDetials @relation("PatientRecalls", fields: [patientId], references: [id])
  patientId String

  appointment   Appointment? @relation(fields: [appointmentId], references: [id])
  appointmentId String?      @unique

  notes   String? // universal notes
  entries RecallEntry[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model RecallEntry {
  id       String @id @default(uuid())
  recall   Recall @relation(fields: [recallId], references: [id])
  recallId String

  mealType MealType
  time     String
  foodItem String
  quantity String
  notes    String?

  createdAt DateTime @default(now())
}

model Slot {
  id          String       @id @default(uuid())
  doctor      Doctor       @relation(fields: [doctorId], references: [id])
  doctorId    String
  startAt     DateTime
  endAt       DateTime
  serviceType ServiceType
  isBooked    Boolean      @default(false)
  appointment Appointment?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@unique([doctorId, startAt])
}

model Appointment {
  id           String            @id @default(uuid())
  service      ServiceType
  startAt      DateTime
  endAt        DateTime
  status       AppointmentStatus @default(PENDING)
  user         User              @relation(fields: [userId], references: [id])
  userId       String
  doctor       Doctor            @relation(fields: [doctorId], references: [id])
  doctorId     String
  patient      PatientDetials    @relation(fields: [patientId], references: [id])
  patientId    String
  slot         Slot?             @relation(fields: [slotId], references: [id])
  slotId       String?           @unique
  paymentId    String?
  amount       Int?
  meetingUrl   String?
  notes        String?
  reminderSent Boolean           @default(false)
  recall       Recall?
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt

  @@index([startAt])
  @@index([doctorId, startAt])
}

model File {
  id          String          @id @default(uuid())
  url         String
  publicId    String
  fileName    String
  mimeType    String
  sizeInBytes Int
  provider    StorageProvider @default(CLOUDINARY)
  patient     PatientDetials? @relation(fields: [patientId], references: [id])
  patientId   String?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
}

model Doctor {
  id             String        @id @default(uuid())
  name           String
  phone          String?       @unique
  specialization String?
  bio            String?
  clinicAddress  String?
  slots          Slot[]
  appointments   Appointment[]
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
}
